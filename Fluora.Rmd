---
title: "Fluora"
author: "Abby Lewis and Mary Lofton"
date: "Last updated: 2023-07-25 ASL"
output: html_document
---

Load packages and FP data
```{r setup, include=FALSE}
#load packages and set options
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(RCurl)

fluora <- read.csv("https://pasta.lternet.edu/package/data/eml/edi/272/7/001cb516ad3e8cbabe1fdcf6826a0a45")
```

Select and export surface data
```{r}
fluora_surface=fluora%>%
  filter(Reservoir=="BVR",
         Site==50,
         Depth_m<1)%>%
  mutate(DateTime = as.Date(DateTime))%>%
  group_by(DateTime)%>%
  mutate(min_depth = min(Depth_m))%>%
  filter(Depth_m==min_depth)

write.csv(fluora_surface,"Processed_data/Fluora_surface.csv", row.names = F)
```

Calculate Cmax depth
```{r}
# Data wrangling to get dataframe ready to calculate metrics
flo_metrics = fluora%>%
  select(Reservoir, 
         Site, Depth_m, 
         DateTime, 
         GreenAlgae_ugL, 
         Bluegreens_ugL, 
         BrownAlgae_ugL, 
         MixedAlgae_ugL, 
         YellowSubstances_ugL, 
         TotalConc_ugL)%>%
  filter(Reservoir == "BVR", Site == 50,
         year(DateTime)%in% c(2021,2022))%>%
  mutate(Date= as.Date(DateTime)) 

# Calculate Cmax depth for each group in a for loop

# Prepare dataframe for Cmax depth
Cmax <- data.frame(matrix(data=NA, ncol=6, nrow=43))
datez <- unique(flo_metrics$Date)

# Extract and standardize cmax depth for each group
for (i in 1:length(datez)){
  dat <- flo_metrics %>%
    filter(Date == datez[i])
  dat <- dat[,c(11,5:8,10,3)]
  for (j in 2:6){
    if(all(dat[,j] == 0)){
      Cmax[i,j] <- NA
    } else {
      max <- dat[which.max(dat[,j]),]
      Cmax[i,j] <- max[1,7]
    }
  }
  Cmax[i,1] <- as.character(dat$Date[1])
}

# Format data for export
Cmax_final <- Cmax
colnames(Cmax_final) <- c("Date","CmaxDepth_GreenAlgae_ugL","CmaxDepth_Bluegreens_ugL","CmaxDepth_BrownAlgae_ugL","CmaxDepth_MixedAlgae_ugL","CmaxDepth_TotalConc_ugL")
# Export data
write.csv(Cmax_final, file = "./Processed_data/FP_CmaxDepth.csv",row.names = FALSE)
```

Compare with PZ depth
```{r}
#read in light attenuation calculations and look @ Cmax relative to pz depth
pz <- read_csv("./Processed_data/attenuation_calc.csv") %>%
  mutate(Date = date(Date))

Cmax <- tibble(Cmax) %>%
  mutate(Date = date(Date))

cmpz <- left_join(Cmax, pz, by = "Date") %>%
  mutate(green_rel_pz = (Zeu-green)/Zeu,
         cyano_rel_pz = (Zeu-cyano)/Zeu,
         brown_rel_pz = (Zeu-brown)/Zeu,
         crypto_rel_pz = (Zeu-crypto)/Zeu,
         total_rel_pz = (Zeu-total)/Zeu,
         green_rel_pz_0.1 = (Zeu_0.1-green)/Zeu_0.1,
         cyano_rel_pz_0.1 = (Zeu_0.1-cyano)/Zeu_0.1,
         brown_rel_pz_0.1 = (Zeu_0.1-brown)/Zeu_0.1,
         crypto_rel_pz_0.1 = (Zeu_0.1-crypto)/Zeu_0.1,
         total_rel_pz_0.1 = (Zeu_0.1-total)/Zeu_0.1) %>%
  select(-(green:r2))%>%
  filter(!is.na(Zeu)) %>%
  mutate(Year = year(Date)) %>%
  gather(green_rel_pz:total_rel_pz_0.1, key = "spectral_group", value = "Cmax_depth_rel_pz") %>%
  mutate(pz_calc = ifelse(grepl("0.1",spectral_group),"0.1%","1%"))

#data wrangling to plot
Cmax_plot <- Cmax %>%
  mutate(Year = year(Date)) %>%
  gather(green:total, key = "spectral_group", value = "Cmax_depth")

cmpz_1 <- cmpz_plot %>% filter(pz_calc == "1%")
cmpz_0.1 <- cmpz_plot %>% filter(pz_calc == "0.1%")

#data wrangling to plot Zeu
pz_plot <- pz %>%
  mutate(Year = year(Date)) %>%
  filter(Year %in% c(2021,2022)) %>%
  select(-(I0:r2)) %>%
  gather(Zeu:Zeu_0.1, key = "perc_light", value = "pz_depth")

jpeg("./Figs/SI_Cmax_depth_pz_1.jpeg", res = 300, width = 6, height = 4, units = "in")
ggplot(data = subset(cmpz_1, cmpz_1$spectral_group != "crypto_rel_pz"), aes(x = spectral_group, y = Cmax_depth_rel_pz, fill = as.factor(Year)))+
  geom_boxplot()+
  geom_hline(yintercept = 0)+
  theme_bw()+
  ggtitle("Photic zone = 1% light; this is ONLY May-July")+
  xlab("Spectral group")+
  ylab("Cmax depth standardized to photic zone depth")+
  labs(fill = "Year")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  scale_x_discrete(labels=c("green_rel_pz" = "Green algae", "cyano_rel_pz" = "Cyanobacteria",
                              "brown_rel_pz" = "Brown algae", "total_rel_pz" = "Total phyto."))
dev.off()

jpeg("./Figs/SI_Cmax_depth_pz_0.1.jpeg", res = 300, width = 6, height = 4, units = "in")
ggplot(data = subset(cmpz_0.1, cmpz_0.1$spectral_group != "crypto_rel_pz_0.1"), aes(x = spectral_group, y = Cmax_depth_rel_pz, fill = as.factor(Year)))+
  geom_boxplot()+
  geom_hline(yintercept = 0)+
  theme_bw()+
  ggtitle("Photic zone = 0.1% light; this is ONLY May-July")+
  xlab("Spectral group")+
  ylab("Cmax depth standardized to photic zone depth")+
  labs(fill = "Year")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  scale_x_discrete(labels=c("green_rel_pz_0.1" = "Green algae", "cyano_rel_pz_0.1" = "Cyanobacteria",
                              "brown_rel_pz_0.1" = "Brown algae", "total_rel_pz_0.1" = "Total phyto."))
dev.off()
```

Calculate peak width
```{r}
#data wrangling
pw <- flo_metrics[,c(3,5:8,10,11)] %>%
  rename(green = GreenAlgae_ugL,
         brown = BrownAlgae_ugL,
         cyano = Bluegreens_ugL,
         crypto = MixedAlgae_ugL,
         total = TotalConc_ugL) %>%
  gather(green:total, key = "spectral_group", value = "chl") %>%
  mutate(key = paste(spectral_group, Date, sep = "_")) %>%
  select(-spectral_group, -Date) %>%
  rename(depth = Depth_m)

data <- pw

#calculate depth distribution characteristics for each profile
profiles <- unique(pw$key)

final <- matrix(NA,nrow = length(unique(pw$key)), ncol = 2)

for (i in 1:length(profiles)){

  profile <- pw %>%
      filter(key == profiles[i])
  
  final[i,1] <- profile$key[1]
  
  #peak width calculation
    max_depth <- unlist(profile[which.max(profile$chl),"depth"])
    conc_med <- mean(profile$chl, na.rm = TRUE)
    
    peak.top.temp <- subset(profile, depth <= max_depth & chl <= conc_med)
    if(nrow(peak.top.temp) == 0){
      peak.top = min(profile$depth, na.rm = TRUE)
    } else {
      peak.top <- unlist(peak.top.temp[which.min(abs(peak.top.temp$depth - max_depth)),"depth"])
    }
  
    peak.bottom.temp <- subset(profile, depth >= max_depth & chl <= conc_med)
    if(nrow(peak.bottom.temp) == 0){
      peak.bottom = max(profile$depth, na.rm = TRUE)
    } else {
      peak.bottom <- unlist(peak.bottom.temp[which.min(abs(peak.bottom.temp$depth - max_depth)),"depth"])
      }
    
    peak.width = abs(peak.top - peak.bottom)
    final[i,2] <- peak.width
    
    plot.df = data.frame(peak.top = peak.top,
                         peak.bottom = peak.bottom,
                         conc_med = conc_med)
    
    #plot profile + peak width
    plot_filename = paste0("./Figs/peak_width_plots_FWB/",profile$key[1],".jpeg")
    # create plot
                  pp0 = ggplot() +
                      geom_line(data = profile, aes(x = depth, y = chl), size = 0.75, color = "springgreen3")+
                      geom_segment(data = plot.df, aes(x = peak.top, y = conc_med, xend = peak.bottom, yend = conc_med, colour = "red"))+
                      scale_y_continuous()+
                      scale_x_reverse()+
                      ggtitle(profile$key[1])+
                      guides(color="none")+
                      labs(x = "Depth (m)", y = "ChlF")+
                      coord_flip()+ 
                      theme_bw() 
                  
                  # write plot to file
                      ppi = 300
                      png(file = plot_filename, width = 3*ppi, height = 3*ppi, res = ppi)
                      print(pp0)
                      dev.off()
  
}

final <- data.frame(final)
colnames(final) <- c("key","peak.width")

pw2 <- final %>%
  mutate(spectral_group = sapply(strsplit(final$key, split='_', fixed=TRUE),"[[",1),
         Date = sapply(strsplit(final$key, split='_', fixed=TRUE),"[[",2)) %>%
  mutate(Year = year(Date)) %>%
  select(Year, Date, spectral_group, peak.width) %>%
  mutate(peak.width = as.numeric(peak.width))

pw2 <- tibble(pw2) %>%
  mutate(Date = as.Date(Date)) %>%
  pivot_wider(names_from = spectral_group, values_from = peak.width) %>%
  rename(PeakWidth_GreenAlgae_m = green,
         PeakWidth_Bluegreens_m = cyano,
         PeakWidth_BrownAlgae_m = brown,
         PeakWidth_MixedAlgae_m = crypto,
         PeakWidth_TotalConc_m = total)

write.csv(pw2, file = "./Processed_data/FP_PeakWidth.csv",row.names = FALSE)
```

Key numbers and stats for manuscript
```{r}
# dominance of cyanobacteria during study period
dom <- flo_metrics %>%
  select(-Reservoir, -Site) %>%
  mutate(Date = date(DateTime)) %>%
  filter((Date >= "2021-05-01" & Date <= "2021-09-01") | (Date >= "2022-05-01" & Date <= "2022-09-01")) %>%
  group_by(Date) %>%
  summarize(GreenAlgae_ugL = mean(GreenAlgae_ugL, na.rm = TRUE),
            Bluegreens_ugL = mean(Bluegreens_ugL, na.rm = TRUE),
            BrownAlgae_ugL = mean(BrownAlgae_ugL, na.rm = TRUE),
            MixedAlgae_ugL = mean(MixedAlgae_ugL, na.rm = TRUE),
            TotalConc_ugL = mean(TotalConc_ugL, na.rm = TRUE)) %>%
  mutate(prop_ga = GreenAlgae_ugL/TotalConc_ugL,
         prop_bg = Bluegreens_ugL/TotalConc_ugL,
         prop_ba = BrownAlgae_ugL/TotalConc_ugL,
         prop_ma = MixedAlgae_ugL/TotalConc_ugL) %>%
  rowwise() %>%
  mutate(dom = max(c(prop_ga, prop_bg, prop_ba, prop_ma))) %>%
  rowwise() %>%
  mutate(dom_group = ifelse(dom == prop_ga, "GreenAlgae",
                            ifelse(dom == prop_bg, "Bluegreens",
                                   ifelse(dom == prop_ba, "BrownAlgae",
                                          ifelse(dom == prop_ma, "MixedAlgae","zombies")))))

dom %>%
  count(dom_group)

```